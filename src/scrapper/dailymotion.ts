const TEST_METADATA = {
    url: "https://www.dailymotion.com/video/x96ndxe",
    filmstrip_url: "https://s2.dmcdn.net/k/X6Z121c_XriGCFDAu",
    protected_delivery: false,
    channel: "animals",
    created_time: 1727909953,
    detected_language: "und",
    duration: 5430,
    explicit: false,
    has_paid_partnership: false,
    id: "x96ndxe",
    is_created_for_kids: false,
    language: "pl",
    media_type: "video",
    partner: false,
    live_show_viewers: false,
    seeker_url: "https://s1.dmcdn.net/n/X6Z121c_Xri9MG07q",
    tags: [],
    title: "Dresiarz3sez01PL",
    verified: false,
    mode: "vod",
    private: true,
    data_center: "dc3",
    view_id: "1i9rmon3r1f9sdhcvde",
    access_id: "k1qHMhAd8SkWeABAfEC",
    is_password_protected: false,
    advertising: {
        ad_url: "https://dmxleo.dailymotion.com/cdn/manifest/video/x96ndxe.m3u8?auth=1728753243-2688-z3y2meqb-a00ca0527ec1b1b240df88d849e074dbkZ564ANTCBBW6Nj8mTjr35RO-U-laRl0z5sTJNouKItdhWQUtV3ByhJMsEhbv0VW70GaRcFEk1Veeu78KDGGKT41bWPBHQCno6tVjTAV--Ql-orXMETSLanWRYghuO7LSLxp2NjC8xEYGZi6tb2wD02TMf_Hw9vhtBH995SklZI-SjEFab2_RItBDnkiLs_phZAaaDiE6qleu2nzWaO0pKm_MVfbllFrxG3BtbIXvnWzxXv_YFlCT91XAC1JpcaKjBR9hjFOFxSbZernzSPcZ4HzJNPXtTy4HFZOnADaVBDzTq32QpdW_In_qptb9KMUUcntZiKjJLSOFhohmheNbzrgNQK-2otd80-MN-b43Nt3gFtB8F99UfeREkRwFKjqkw65e6eFBzUMqlnEZdNz7mQHvo7gXHU7TsaghZyvd6y0A5oVZq5O6UWVEgchZHIzj5Q1-ahmiaUvGlSNDIoOzf3jzspMkveLm0Y0CIvKXcgCd0Vz-yZPYafCTrd0Sf33ZQeqeclJSfW7BAVPU9rqkJRN7lSh1Gs5jBTXP5HiNTedLmqGyXkuldDbr2vk618LB2J8CuDYNPHBOyBybGNyh2s-LnhAtGFDoEm8BwA3KD10ulx3w1hnRrcj-fTcWtaYc8kEcHTZjAwRnMQIBHk3ToPeUhDHL9nL4AKKUz_bzKop5lYTmBZuxmSFmlqSV3SdNPF0kpVBbbdDXo9XtvGiansnlGs9IyySr6lkfgI2uysY2BvsczwSb471iMorQBZcKuaAt8G82dMdO5dsGVVPMgaX6_QQRVbgCLQhv_Jr1Hebe6gz8TizYIj-BgbEvZsWNO6ujO6HLJJjVL57zHCftu7tw16M5VY96flxhQJZssSLyPRPQ6s4dMom8w3UC21m9n-Fr8ETJLKLtm87ANrgFVvxJTpDLouPskU195j3iK8TxTiS_hDRi19yFWrqDZ8v5_QaMvbRRMQT5Z1E5oBaz5Rh_ZGqe9GBJigm5jZ7ojtTMLsALRh5he9UPwyGyAjg8&af=[APIFRAMEWORKS]&vv=[VASTVERSIONS]&mm=[MEDIAMIME]&pbm=[PLAYBACKMETHODS]",
        ad_error_url:
            "https://dmxleo.dailymotion.com/cdn/manifest/video/x96ndxe.m3u8?auth=1728753243-2562-nxhwydbi-bd69712198c9a9a76c84eccaff00ea3fLK75UCF7zOe6LejK-z10y_SH2MX6DfOQPBlCW42Y_q25FQssfDgMmHcgZOHSw1U3QunlVNXykx_XhFOwqvd_FS7kvdUQhiYewhUq0cMT1ePkOTDnwXDVerAiEkyPO_A2sf3Rto-qTmZvE0Rl5Ntki0xN0XtIsGIc5HjvniisqSJVoMM5xz-s_xJZnApvHQmY63WEXPSIK8lgXQK0Loj_uuJ7hup4pHixV8_uymJDuD7zDJ56fmajSsbG1Xpy9GfDIYJJzSvUVHBK8nmI15hUO3hsQEJ0cZ-xLfI0X8R617PtHOy-bFy9q88G5fW4VTw7g1921XbcA8YT3IeVw9SvWXqZ5QGFXmUlvCinPdbTB2PQkuul8-PqAeFBJrENK9uJCnVdMK-P4S6_VNuvdzcY2eISpjO3YfAjWlyFGSQ9g5evB06jTzwlhK9vnl7MdNRrEP9Z2pFfwExikTSBGfqa8uWjC4pUVPtph0CWw1g8P7Rd0Irt6C6uGVxK8GtXVkr4WIN2RpE0DZfcfpHRfyDTmO7UEOFFmQXVI6_xXW86RSESG_SYZsvPZecCW31XfweWcZNSoE_dlqOByaCSeUN490_N0NLyURyy5-IRL9aXZZmtZ4MBRNQ_pRrInYq_0YobCHiJshF_FFPqZa7wpfCkITt5s3_403X3KhfVzrst1Uo2h4s6FYteer4E2_MCU3oGtZa10707Qk9tzL8a85RARcAj4aKWeCN8cnTdcIeEg7UDF0BptRqxODuvGvk9mUoWT-FyLgjoStJugnWeG33Un5qH5WmuIJETayv3JYR6YjOEjSZoUMAdhaqqD8apLWdsolkBOLmmY_antiy6IobpV9fByAWLO9M4ysqdxNq21cXvYwgz7t4EGpJCZXBjsQVZ-LNLGWY_H9PJwfzjeJ7GU85pUidUskaBbF_hcc2KC8ZKKsJBa31o7WWrXpnICs3Jp8D6gsZznbJpa_FSznCvp3F-i6N3ULba7gyzN_VfQkokGDl24bElXkoCIs1mQTaXp&af=[APIFRAMEWORKS]&vv=[VASTVERSIONS]&mm=[MEDIAMIME]&pbm=[PLAYBACKMETHODS]&error=[ERRORCODE]",
        ad_sync_script_url:
            "https://dmxleo.dailymotion.com/cdn/manifest/video/x96ndxe.m3u8?auth=1728753243-2562-b4yjnxv2-b246c5fd87efe321d429919092770a3dKDOycGXvl3wqt9GSSz7FuV9sG6quKrBNkG6nCS2FEvVecZ9WzxVtRptjo0VBb50sQYCI7NCMFVVrxV5r5J2v8YmAQPHhOEYYO-AnlEOtj_rpg6RWR7pEwf_kZwfPDTruHCxGCUz8c9lzWo3dvuQhGdbi1rXrNkG9AqAmoLYRWA8_HzHTJNJhmMsdWJui9LXTQeluTC1_FG6voC8f3U483fChSj-olkiRONZlKRbpPEkmggYasyfYI-J3qF0PHlb-x2VsOT7d-7Wlhr9RsP73n6yHOB9JqLRr5IeXAeI6u7RFbDaupSPbOBannDrMShNnAAyrNInQbmO4bmMTAkpqV27Zx11EXBpz79XBaOln17L64sUgtBdZreOhN0voJEgRqxN6YWAvVoR6V97nbOZnN0LIeTvlKQJoIJdTcNQn_MZ_KFFEiAVFam4Tppj3OCP_E4dkHm5y4vaHHvC--XVa3eFV3dAG_Fq9MxrKxiZHUKzZq50qJXtciLQdUD4VtjZBcQ0xs-_aldqammd0PFbjby6IW3nkvlW-N7aJhs313QUn74RScOAiBf4sgh90SASizyKKQ00CvL_st4qx722GghBmj-FI5iElCKhjGicjAfnSruw_C8R9DO5GYhSs0umhqWJdofcqrTX2UOpCkPyvRBKQcAmRA4_7L_nHbuxixZsvTuCzCG3MmfyODXPKUuIlVGUbBHxBVIEohq7NUzxBG7u4pzrtlriWuFL8mO_eWUfBs-5AdREwnYKhBRi-CWucE4Szt9QqkWJbLBAPagTOjPdoV7tdizPWKnoj2WwVe3ILXrKd8N0dr4rk5ohqej1ENaqILgXt_gVvwZNu3LAcDWUWINdSP7hjlFq-CbnDsTzqlfB0rmcAkQ6whOZY0Kj_F3e5TTxrohzP7gXrIGMcStSYluvRGiSVB7r_a8TRD1xMeiSZ5wILhlTPAeGLE2rGpl7kskQJjXlXh8qGxSyBZtSE9b3XA0ELiPRBmv8Hz3sgzAYfsYOK8WnrMr_QiH3KD&af=[APIFRAMEWORKS]&vv=[VASTVERSIONS]&mm=[MEDIAMIME]&pbm=[PLAYBACKMETHODS]&bs=1",
        ima: { enable: false },
    },
    thumbnails: {
        "60": "https://s1.dmcdn.net/v/X6Z121c_XriKWC70y/x60",
        "120": "https://s1.dmcdn.net/v/X6Z121c_XriDW2uoG/x120",
        "180": "https://s1.dmcdn.net/v/X6Z121c_Xri6bIZ7u/x180",
        "240": "https://s1.dmcdn.net/v/X6Z121c_Xri_XycfP/x240",
        "360": "https://s1.dmcdn.net/v/X6Z121c_Xri5mgtQ3/x360",
        "480": "https://s1.dmcdn.net/v/X6Z121c_XriKnBil4/x480",
        "720": "https://s2.dmcdn.net/v/X6Z121c_Xri4NVKrt/x720",
        "1080": "https://s2.dmcdn.net/v/X6Z121c_XriGAAglH/x1080",
    },
    first_frames: {
        "60": "https://s2.dmcdn.net/1/X6Z121c_Xri8KxBj6/108x60f",
        "120": "https://s1.dmcdn.net/1/X6Z121c_Xri-Y74hq/216x120f",
        "180": "https://s2.dmcdn.net/1/X6Z121c_XriaU8DEY/320x180f",
        "240": "https://s1.dmcdn.net/1/X6Z121c_XriurT1yu/428x240f",
        "360": "https://s2.dmcdn.net/1/X6Z121c_Xri7Qj_Zl/640x360f",
        "480": "https://s2.dmcdn.net/1/X6Z121c_Xri6dXIgU/856x480f",
        "720": "https://s2.dmcdn.net/1/X6Z121c_Xriv44Fde/1280x720f",
        "1080": "https://s1.dmcdn.net/1/X6Z121c_XrinjKP1K/1920x1080f",
    },
    owner: {
        id: "x2tyghq",
        parent_id: null,
        screenname: "fanbojeleny",
        url: "https://www.dailymotion.com/fanbojelenki",
        username: "fanbojelenki",
        avatars: { "60": "https://s2.dmcdn.net/u/ADGp-1d1jlF9zE9UY/60x60" },
        type: "ugc",
        watermark_image_url: null,
        watermark_link_url: null,
    },
    player_owner: {
        id: null,
        watermark_image_url: null,
        watermark_link_url: null,
    },
    qualities: {
        auto: [
            {
                type: "application/x-mpegURL",
                url: "https://www.dailymotion.com/cdn/manifest/video/x96ndxe.m3u8?sec=22cSdWG6r1guivwnuyg6Mkts9XAhm6VZ3f9xOZNfaTw4UkCXnm9PFSMzdHeUSBmizYarMKv7nrLAFgnPnNcCrg&dmTs=343707&dmV1st=8fdfc0d5-3bc1-4dd2-90ae-e71c1e6a99c4",
            },
        ],
    },
    reporting: {
        enable: true,
        tracking: {
            internal:
                "https://www.dailymotion.com/logger/video/access/x96ndxe?session_id=&referer=&country=PL&user_agent=Mozilla%2F5.0+%28Windows+NT+10.0%3B+Win64%3B+x64%29+AppleWebKit%2F537.36+%28KHTML%2C+like+Gecko%29+Chrome%2F129.0.0.0+Safari%2F537.36&channel_id=7&class=ugc&mode=vod&visitor_embedder=&src_ref=&client_embedder=&video_id=555364418&v1st=8fdfc0d5-3bc1-4dd2-90ae-e71c1e6a99c4&pid=67080b5b42d83&visitor_referer=&view_id=1i9rmon3r1f9sdhcvde&traffic_segment=35&bot_risk_score=-1&owner_id=171248894&blog_key=&key=595c4di8m508sse8osl5pjc&v=67083588&i=1fb6f318&h=19a23ab651f5fb8d2ba34bf723cc74c2",
            history:
                "https://www.dailymotion.com/history/log/user/fanbojelenki/video/x96ndxe?action=start&dmV1st=8fdfc0d5-3bc1-4dd2-90ae-e71c1e6a99c4&dmTs=343707",
            "history@80%|10m":
                "https://www.dailymotion.com/history/log/user/fanbojelenki/video/x96ndxe?action=complete&dmV1st=8fdfc0d5-3bc1-4dd2-90ae-e71c1e6a99c4&dmTs=343707",
            "behavior@40%|3m":
                "https://tofu.dmcdn.net/behavior/ed48da1c7f3e435667294eb60bff308e/x96ndxe?explicit=0",
        },
        estat: null,
        google: null,
        ias: { anid: "923995", partner: "dailymotion" },
        comScore: { c2: "4000005", c3: "Dailymotion_Lifestyle", c4: "0508" },
    },
    sharing: null,
    stream_type: "recorded",
    subtitles: { enable: false, data: [] },
    ui: {},
    info: { enable: true },
    consent: {},
};

const TEST_M3U8 = `
#EXTM3U
#EXT-X-STREAM-INF:BANDWIDTH=2149280,CODECS="mp4a.40.2,avc1.64001f",RESOLUTION=1280x720,NAME="720",PROGRESSIVE-URI="https://vod.cf.dmcdn.net/sec2(89-CHA4HobDfjQlBkuGKjO3_iAgw1iOYS1pbkULgCMozFX16LReHXia_OQqPI0Iiknph-hn4UDHQpOCR28eegDv_QMF9QYRJ9nJLogL8qCT1IXjK0xaB6wVfwGKqPf5L7O7647kP8ezELxbtKxvlhOy7qfA8YKkybqJ0hqVKYaxLhQTvG411STEk1tLqImmn)/video/814/463/555364418_mp4_h264_aac_hd_2.mp4#cell=cf"
https://vod.cf.dmcdn.net/sec2(Q49t83SedbGpZ3P6OEpoxOsqn42OaOhoT4CY-5aKpIScHM-gUtBj8iDUTksbTIZlpJba2F000i3AiTf9-lx8gjtLbnk6HiKdk43se0tIJFXqD5Avf1zz2GJfK2C77UVNjlUm3aBzzCwAaGXpfCnfTakWsBMCIlTwAsYcKnsm6tMRXsDSM55_58tKEx-Skkc1)/video/814/463/555364418_mp4_h264_aac_hd_2.m3u8#cell=cf
#EXT-X-STREAM-INF:BANDWIDTH=460560,CODECS="mp4a.40.5,avc1.4d0016",RESOLUTION=512x288,NAME="380",PROGRESSIVE-URI="https://vod.cf.dmcdn.net/sec2(99iruXiNxsq_Nb9OEhB4rdWxnGpeoTE6un2Gcy7xysYkLHapNFxNSArmI20So19MGzw9MmgBIZ8s7caB_5QM4T8rUn-NIr4OZSaB3L4gVTR32I3AFaPT1Fbe5DLwYgcRT-W00dhQXS7sGzYXIKrtReTubxGxffd-bYgMQhzqVQG4ehR2UMCG1s8tgA0QPlPe)/video/814/463/555364418_mp4_h264_aac_2.mp4#cell=cf"
https://vod.cf.dmcdn.net/sec2(a2OUMV77Shrt8HzHa8_LtASRCoXl6oeKBqBq8qoEcAu_x8_-3_EmdPQD3OqN64iVpAMNWO_1cCMkj_8b_h5L2YDUIBMF5Zd3OlnbbsjeyUiQTmRPFk5IVpghEqNa0FtQufVqY-qKTF1Leyl9SOZU06-rKMDwH6HYgrX1LThdi2A)/video/814/463/555364418_mp4_h264_aac_2.m3u8#cell=cf
#EXT-X-STREAM-INF:BANDWIDTH=836280,CODECS="mp4a.40.2,avc1.64001f",RESOLUTION=848x480,NAME="480",PROGRESSIVE-URI="https://vod.cf.dmcdn.net/sec2(I5Dqhl1J4vBxMrPtLZFZtWuiVuxzna4dWEINo4OKhgGeUAucZshlXroyw0CLNbDDRmhmZViv6J14FEFWhlCD_9Abhb4K8p7d6fH3VV-3igtlXHQO0d-cwQ2ptzngGncMVlwvpwrojoMKCTJTyfhHP7HOgih1Ea9VSyKfG4wcmx9Be_dyXEraIAaamesfj8B7)/video/814/463/555364418_mp4_h264_aac_hq_2.mp4#cell=cf"
https://vod.cf.dmcdn.net/sec2(78OJINeeK91LxYX9jaAbtLqNO_mb5M0C3jJYfChkwPXxzRmij5g14pOFmMWAhWNWIQ-pYmAtLhg5tIjz5w6tOj36DDrAICnXzFRdRluDWFxOsFq_8chrhoOauLYOHyF6_cruGzYd1P-DqfUVMwfNvDlyKJDhu-pK4i_pXcL44Z9lgeaxYiYFcfhf4agFtAH0)/video/814/463/555364418_mp4_h264_aac_hq_2.m3u8#cell=cf
#EXT-X-STREAM-INF:BANDWIDTH=6221600,CODECS="mp4a.40.2,avc1.640028",RESOLUTION=1920x1080,NAME="1080",PROGRESSIVE-URI="https://vod.cf.dmcdn.net/sec2(y6Jfo9bpj77bmvshrZmArvATlp1n0_PXgAXExiQdDlyLS7HM3-0PtTdSOVWs3QrOuuZQ-i6d3Hvj_d1Zh6UAUUWohS48jGCbG2wyVtTJZSAdR3sD0PHaellDUbXshzvVuE42QvmYfhHFH4LmdzVU4-qmY826lncoBeuAq8_V2LAzymU8MirnyL6my8o17ebp)/video/814/463/555364418_mp4_h264_aac_fhd_2.mp4#cell=cf"
https://vod.cf.dmcdn.net/sec2(cIojOzw7lYCkZEhPtv9no5k5D3anb5V8gemlSDUWt-SYkYruJAqDY79oMOehw-E009hZfF24GQnPNZ2blOOlHhvMegh3JfWsDILNj8x5-y276qqhYo6h4ZKPJgk1s524i_6ZsfJ8OV1VIS-_HbwBzfKDswbqjKQUx7iPhQ4PLfOp0GJT4MJADdGZSJVAmdNC)/video/814/463/555364418_mp4_h264_aac_fhd_2.m3u8#cell=cf

`;

export class Dailymotion {
    private videoId: string;
    private metadata: any = {};
    private m3u8Url: string = "";
    private rawM3U8: string = "";
    private m3u8Data: any = {};
    qualities: { quality: number; url: string }[] = [];
    title: string = "";
    thumbnail: string = "";

    constructor(videoId: string) {
        this.videoId = videoId;
    }

    public fetchData = async () => {
        this.metadata = await this.fetchMetadata();
        this.m3u8Url = this.metadata.qualities.auto[0].url;
        this.rawM3U8 = await this.fetchM3U8();
        this.m3u8Data = this.parseM3U8();
        this.qualities = this.extractResolutions();
        this.title = this.metadata.title;
        this.thumbnail = this.metadata.thumbnails["720"];
    };

    private fetchMetadata = async (): Promise<any> => {
        // return TEST_METADATA;
        const response = await fetch(
            "https://www.dailymotion.com/player/metadata/video/" + this.videoId,
            {
                headers: {
                    accept: "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
                    "accept-language": "pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7",
                    "cache-control": "max-age=0",
                    "sec-ch-ua":
                        '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": '"Windows"',
                    "sec-fetch-dest": "document",
                    "sec-fetch-mode": "navigate",
                    "sec-fetch-site": "none",
                    "sec-fetch-user": "?1",
                    "upgrade-insecure-requests": "1",
                    "user-agent":
                        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36",
                },
                method: "GET",
            }
        );

        if (!response.ok) {
            throw new Error("Failed to fetch metadata");
        }

        return await response.json();
    };

    private fetchM3U8 = async (): Promise<any> => {
        // return TEST_M3U8;
        const response = await fetch(this.m3u8Url, {
            headers: {
                accept: "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
                "accept-language": "pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7",
                "cache-control": "max-age=0",
                "sec-ch-ua":
                    '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": '"Windows"',
                "sec-fetch-dest": "document",
                "sec-fetch-mode": "navigate",
                "sec-fetch-site": "none",
                "sec-fetch-user": "?1",
                "upgrade-insecure-requests": "1",
                "user-agent":
                    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36",
            },
            method: "GET",
        });

        if (!response.ok) {
            throw new Error("Failed to fetch m3u8 playlist");
        }

        return await response.text();
    };

    private parseM3U8 = (): any => {
        const lines = this.rawM3U8.split("\n");
        const data: any = [];

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith("#EXT-X-STREAM-INF")) {
                //@ts-ignore
                const stream = {
                    bandwidth: line.match(/BANDWIDTH=(\d+)/)?.[1] || "",
                    codecs: line.match(/CODECS="([^"]+)"/)?.[1] ?? "",
                    resolution: line.match(/RESOLUTION=(\d+x\d+)/)?.[1] || "",
                    name: Number(line.match(/NAME="([^"]+)"/)?.[1]) ?? "",
                    url:
                        (line.match(/PROGRESSIVE-URI="([^"]+)"/)?.[1] ?? "") +
                        "#cell=cf",
                };
                data.push(stream);
            }
        }

        return data.sort((a: any, b: any) => a.name - b.name);
    };

    private extractResolutions = (): { quality: number; url: string }[] => {
        const qualities: { quality: number; url: string }[] = [];
        const qualitiesData = this.m3u8Data;

        for (let i = 0; i < qualitiesData.length; i++) {
            const quality = qualitiesData[i];
            qualities.push({
                quality: quality.name,
                url: quality.url,
            });
        }

        return qualities.sort((a, b) => a.quality - b.quality).reverse();
    };
}
